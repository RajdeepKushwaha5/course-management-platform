{% extends 'base.html' %}

{% load static %}

{% block meta_robots %}
  <meta name="robots" content="noindex">
{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'course' course.slug %}">{{ course.title }}</a></li>
<li><a href="{% url 'homework' course.slug homework.slug %}">{{ homework.title }}</a></li>
{% endblock %}

{% block content %}

<h1 class="mb-4">
  {{ homework.title }} - All Submissions
</h1>

{% if messages %}
  {% for message in messages %}
  {% if 'homework' in message.tags %}
    <div class="alert {{ message.tags }}">
      <p>{{ message }}</p>
    </div>
  {% endif %}
  {% endfor %}
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">
      <i class="fas fa-info-circle"></i> Total Submissions
    </h5>
    <p class="card-text display-4">{{ submissions_data|length }}</p>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="fas fa-list"></i> Submissions List
    </h5>
  </div>
  <div class="card-body">
    {% if submissions_data %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Email</th>
              <th>Submitted At</th>
              {% for question in questions %}
              <th>Q{{ forloop.counter }}</th>
              {% endfor %}
              <th>Homework Link</th>
            </tr>
          </thead>
          <tbody>
            {% for item in submissions_data %}
            <tr>
              <td>{{ item.submission.student.email }}</td>
              <td>{{ item.submission.submitted_at|date:"Y-m-d H:i:s" }}</td>
              {% for answer in item.answers %}
              <td>
                {% if answer %}
                  {% if answer|length < 1000 %}
                    <div style="max-width: 400px; white-space: pre-wrap; word-wrap: break-word;">
                      {{ answer }}
                    </div>
                  {% else %}
                    <div>
                      <div id="answer-short-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" style="max-width: 400px; white-space: pre-wrap; word-wrap: break-word;">
                        {{ answer|truncatechars:200 }}
                      </div>
                      <div id="answer-full-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" style="max-width: 400px; white-space: pre-wrap; word-wrap: break-word; display: none;">
                        {{ answer }}
                      </div>
                      <button class="btn btn-sm btn-outline-primary mt-1 toggle-answer" 
                              data-short-id="answer-short-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                              data-full-id="answer-full-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                        <i class="fas fa-chevron-down"></i> Show All
                      </button>
                    </div>
                  {% endif %}
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              {% endfor %}
              <td>
                {% if item.submission.homework_link %}
                  <a href="{{ item.submission.homework_link }}" target="_blank" rel="noopener noreferrer">
                    <i class="fas fa-external-link-alt"></i> View
                  </a>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No submissions yet.</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  $('.toggle-answer').click(function() {
    var shortId = $(this).data('short-id');
    var fullId = $(this).data('full-id');
    var $short = $('#' + shortId);
    var $full = $('#' + fullId);
    var $icon = $(this).find('i');
    
    if ($full.is(':visible')) {
      $full.hide();
      $short.show();
      $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
      $(this).html('<i class="fas fa-chevron-down"></i> Show All');
    } else {
      $short.hide();
      $full.show();
      $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
      $(this).html('<i class="fas fa-chevron-up"></i> Show Less');
    }
  });
});
</script>
{% endblock %}
